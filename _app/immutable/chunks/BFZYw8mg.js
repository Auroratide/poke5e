import{w as b}from"./DNTgK4in.js";import{p as a}from"./DxQlPuZ1.js";import{e as u}from"./Bpj21dPT.js";import"./BxlXVsHr.js";const K=()=>{const{subscribe:A,update:f}=b({}),y={};let I;const c=(m,h)=>{f(p=>({...p,[m]:{...p[m],...h(p[m])}}))},T=m=>()=>a.removeTrainer(m.id,m.readKey).then(()=>{f(h=>{const{[m.readKey]:p,...d}=h;return d})});return{get:m=>(y[m]==null&&(y[m]=a.getTrainer(m).then(h=>{var g;if(h==null)return;c(h.info.readKey,()=>h);const p=o=>({info:async(e,t={})=>{const n=o.info;let i=e.avatar;t.updateAvatar!=null&&(t.updateAvatar.type==="new"?i=await a.updateTrainerAvatar(o.writeKey,t.updateAvatar.value,e.avatar).catch(r=>{throw u.show(r.message),r}):(await a.removeTrainerAvatar(o.writeKey,e.avatar).catch(r=>{throw u.show(r.message),r}),i=null));const s=r=>c(m,w=>({...w,info:{...w.info,...r,avatar:i}}));return t.optimistic?(s(e),a.updateTrainerInfo(o.writeKey,e).then(()=>{}).catch(r=>{throw s(n),u.show(r.message),r})):a.updateTrainerInfo(o.writeKey,e).then(()=>{s(e)}).catch(r=>{throw u.show(r.message),r})},inventory:e=>a.updateTrainerInventory(o.writeKey,e.inventory).then(t=>{c(m,n=>({...n,info:{...n.info,inventory:t}}))}).catch(t=>{throw u.show(t.message),t}),inventoryItem:(e,t={})=>{let n;const i=s=>{c(m,r=>{const w=r.info.inventory.findIndex(l=>l.id===s.id);return n=r.info.inventory[w],r.info.inventory[w]=s,{...r}})};return t.optimistic?(i(e),a.updateTrainerItem(o.writeKey,e).then(()=>{}).catch(s=>{throw i(n),u.show(s.message),s})):a.updateTrainerItem(o.writeKey,e).then(()=>{i(e)}).catch(s=>{throw u.show(s.message),s})},trainerFeats:e=>a.updateTrainerFeats(o.writeKey,e.feats).then(t=>{c(m,n=>({...n,info:{...n.info,feats:t}}))}).catch(t=>{throw u.show(t.message),t}),retire:()=>a.deleteTrainer(o.writeKey,o.info.id,o.info.readKey).then(()=>{f(e=>{const{[o.info.readKey]:t,...n}=e;return n})}).catch(e=>{throw u.show(e.message),e}),pokemon:async(e,t={})=>{let n,i=e.avatar;t.updateAvatar!=null&&(t.updateAvatar.type==="new"?i=await a.updatePokemonAvatar(o.writeKey,e,t.updateAvatar.value).catch(r=>{throw u.show(r.message),r}):(await a.removePokemonAvatar(o.writeKey,e).catch(r=>{throw u.show(r.message),r}),i=null));const s=r=>c(m,w=>{const l=[...w.pokemon],k=l.findIndex(x=>x.id===r.id);return n=l[k],l[k]={...w.pokemon[k],...r,avatar:i},{...w,pokemon:l}});return t.optimistic?(s(e),a.updatePokemon(o.writeKey,e).then(()=>{}).catch(r=>{throw s(n),u.show(r.message),r})):a.updatePokemon(o.writeKey,e).then(()=>{s(e)}).catch(r=>{throw u.show(r.message),r})},moveset:e=>a.updateMoveset(o.writeKey,e.id,e.moves).then(t=>{c(m,n=>{const i=[...n.pokemon],s=i.findIndex(r=>r.id===e.id);return i[s]={...n.pokemon[s],moves:t},{...n,pokemon:i}})}).catch(t=>{throw u.show(t.message),t}),move:(e,t={})=>{let n;const i=s=>{c(m,r=>{const w=r.pokemon.find(k=>k.moves.map(x=>x.id).includes(s.id));if(!w)return r;const l=w.moves.findIndex(k=>k.id===s.id);return n=w.moves[l],w.moves[l]=s,{...r}})};return t.optimistic?(i(e),a.updateOneMove(o.writeKey,e).then(()=>{}).catch(s=>{throw i(n),u.show(s.message),s})):a.updateOneMove(o.writeKey,e).then(()=>{i(e)}).catch(s=>{throw u.show(s.message),s})},heldItems:e=>a.updateAllHeldItems(o.writeKey,e.id,e.items).then(t=>{c(m,n=>{const i=[...n.pokemon],s=i.findIndex(r=>r.id===e.id);return i[s]={...n.pokemon[s],items:t},{...n,pokemon:i}})}).catch(t=>{throw u.show(t.message),t}),pokemonFeats:e=>a.updatePokemonFeats(o.writeKey,e.id,e.feats).then(t=>{c(m,n=>{const i=[...n.pokemon],s=i.findIndex(r=>r.id===e.id);return i[s]={...n.pokemon[s],feats:t},{...n,pokemon:i}})}).catch(t=>{throw u.show(t.message),t}),addToTeam:e=>a.addPokemonToTeam(o.writeKey,o.info.id,e).then(t=>(c(m,n=>{const i=[...n.pokemon,t];return{...n,pokemon:i}}),t)).catch(t=>{throw u.show(t.message),t}),removeFromTeam:e=>a.removePokemon(o.writeKey,e).then(()=>{c(m,t=>{const n=t.pokemon.filter(i=>i.id!==e);return{...t,pokemon:n}})}).catch(t=>{throw u.show(t.message),t})});let d;((g=h.writeKey)==null?void 0:g.length)>0&&(d=p(h));let v=!1;return{subscribe:o=>A(e=>{o(e[m]??{...h,update:d,remove:T(h.info)}),v||(v=!0,f(t=>({...t,[m]:{...h,update:d,remove:T(h.info)}})))}),verifyAccess:o=>a.verifyWriteKey(h.info,o).then(e=>(e&&c(m,t=>({...t,writeKey:o,update:p({...t,writeKey:o})})),e))}})),y[m]),all:()=>(I==null&&(I=a.allTrainers().then(m=>{let h=!1;return{subscribe:p=>A(d=>{p(Object.values(d).map(v=>v.info)),h||(h=!0,f(v=>m.reduce((g,o)=>({[o.readKey]:{info:o,pokemon:[],remove:T(o)},...g}),v)))})}})),I),new:m=>a.newTrainer(m).then(h=>(c(h.info.readKey,()=>h),h))}},M=K();export{M as t};
