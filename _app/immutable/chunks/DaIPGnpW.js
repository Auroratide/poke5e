var ne=Object.defineProperty;var oe=(i,e,t)=>e in i?ne(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var d=(i,e,t)=>oe(i,typeof e!="symbol"?e+"":e,t);import{b as k}from"./BLsvBlSC.js";import{r as V,w as b,d as w}from"./Dfgn4MJt.js";import{D as c}from"./Bf-g66YD.js";import"./IHki7fMi.js";import"./CxfxKJMp.js";/* empty css        *//* empty css        *//* empty css        *//* empty css        */import"./CdRAs_Ty.js";/* empty css        *//* empty css        */import"./1V62IcXr.js";import{P as X}from"./DLn0St_8.js";import{e as de,P as le,s as Y,a as ue}from"./CyK43p-P.js";/* empty css        */import"./Bd0Tnl-d.js";/* empty css        */import{X as ce}from"./BVQ5FNs6.js";/* empty css        *//* empty css        */class h extends c{isFakemon(){return this.data.startsWith("F.")}toFakemonReadKey(){if(!this.isFakemon())throw new Error("Attempted to convert non-fakemon species identifier into a fakemon read key.");return this.data.substring(2)}static fromSpeciesName(e){return new h(e)}static fromFakemonReadKey(e){return new h(`F.${e}`)}}class Z extends c{constructor(){super(...arguments);d(this,"score",t=>({score:t,modifier:Math.floor(t/2)-5}))}get str(){return this.score(this.data.str)}get dex(){return this.score(this.data.dex)}get con(){return this.score(this.data.con)}get int(){return this.score(this.data.int)}get wis(){return this.score(this.data.wis)}get cha(){return this.score(this.data.cha)}}d(Z,"list",[{abbr:"str",name:"Strength"},{abbr:"dex",name:"Dexterity"},{abbr:"con",name:"Constitution"},{abbr:"int",name:"Intelligence"},{abbr:"wis",name:"Wisdom"},{abbr:"cha",name:"Charisma"}]);const he={Tiny:"tiny",Small:"small",Medium:"medium",Large:"large",Huge:"huge",Gargantuan:"gargantuan"};function me(i){return Object.values(he).includes(i)}class E extends c{constructor(){super(...arguments);d(this,"mergeWith",t=>{const s=Object.fromEntries(Object.entries(t.data).filter(([,r])=>r!=null)),a={...this.data,...s};return new this.constructor(a)})}static fromList(t,s){return new t(s.reduce((a,r)=>({...a,[r.type]:r.value}),{}))}}const H=["d4","d6","d8","d10","d12","d20"];class D extends c{constructor(){super(...arguments);d(this,"sizeAsInt",()=>parseInt(this.data.slice(1)))}static isHitDice(t){return H.includes(t)}}d(D,"list",H);class M extends E{}d(M,"types",{Walking:"walking",Climbing:"climbing",Swimming:"swimming",Flying:"flying",Hover:"hover",Burrowing:"burrowing"});class R extends E{}d(R,"types",{Darkvision:"darkvision",Blindsight:"blindsight",Tremorsense:"tremorsense",Truesight:"truesight"});const p=class p extends c{constructor(){super(...arguments);d(this,"toList",()=>Object.entries(this.data).filter(([,t])=>t>0).map(t=>t[0]));d(this,"addProficiencies",t=>{for(const s of t)this.data[s]===0&&(this.data[s]=1);return this});d(this,"isProficient",t=>this.data[t]>0);d(this,"isExpert",t=>this.data[t]>1);d(this,"modifier",(t,s,a)=>{const r=p.list.find(n=>n.name===t).attribute;return s[r].modifier+a.proficiencyBonus})}static fromList(t){return new p(p.list.reduce((s,a)=>({...s,[a.name]:t.includes(a.name)?1:0}),{}))}};d(p,"list",[{name:"athletics",attribute:"str"},{name:"acrobatics",attribute:"dex"},{name:"sleight of hand",attribute:"dex"},{name:"stealth",attribute:"dex"},{name:"arcana",attribute:"int"},{name:"history",attribute:"int"},{name:"investigation",attribute:"int"},{name:"nature",attribute:"int"},{name:"religion",attribute:"int"},{name:"animal handling",attribute:"wis"},{name:"insight",attribute:"wis"},{name:"medicine",attribute:"wis"},{name:"perception",attribute:"wis"},{name:"survival",attribute:"wis"},{name:"deception",attribute:"cha"},{name:"intimidation",attribute:"cha"},{name:"performance",attribute:"cha"},{name:"persuasion",attribute:"cha"}]);let C=p;class P extends c{toList(){return this.data.normal.map(e=>({id:e,hidden:!1})).concat(this.data.hidden.map(e=>({id:e,hidden:!0})))}findApplicableAbility(e){const t=this.data.normal,s=this.data.hidden,a=e.normal>=0?t[Math.min(t.length-1,e.normal)]:void 0,r=e.hidden>=0?s[Math.min(s.length-1,e.hidden)]:void 0;if(e.hidden>=0&&r==null){const n=t[t.length-1];return n?{id:n,hidden:!1}:void 0}return a?{id:a,hidden:!1}:r?{id:r,hidden:!0}:void 0}findIndex(e){const t=this.data.normal.indexOf(e),s=this.data.hidden.indexOf(e);return{exists:t>=0||s>=0,normal:t,hidden:s}}isEmpty(){return this.data.normal.length===0&&this.data.hidden.length===0}static fromList(e){return new P({normal:e.filter(t=>!t.hidden).map(t=>t.id),hidden:e.filter(t=>t.hidden).map(t=>t.id)})}static groupSpeciesByAbility(e,t){if(e==null||t==null||(e==null?void 0:e.length)===0||(t==null?void 0:t.length)===0)return{};const s=a=>r=>r.abilities.findIndex(a).exists;return e.reduce((a,r)=>({...a,[r]:t.filter(s(r))}),{})}}const ft=V(void 0,i=>{typeof window<"u"&&fetch(`${k}/abilities.json`).then(e=>e.json()).then(e=>i(e.abilities))}),ve=["monster","human-like","water 1","water 2","water 3","bug","mineral","flying","amorphous","fairy","ditto","dragon","field","grass","gender unknown","undiscovered"];class ee extends c{constructor(){super(...arguments);d(this,"isExclusive",()=>this.data.length===1);d(this,"map",t=>this.data.map(t));d(this,"toString",()=>this.data.join(", "))}static groupBy(t){const s=new Map;for(const a of t)a.eggGroups.map(r=>{s.has(r)||s.set(r,{exclusive:[],shares:[]}),a.eggGroups.isExclusive()?s.get(r).exclusive.push(a):s.get(r).shares.push(a)});return s}}d(ee,"standardList",ve);class pe extends c{constructor(){super(...arguments);d(this,"isGenderless",()=>{const[t,s]=this.ratio();return t+s===0});d(this,"percentFemale",()=>this.percentOf(0));d(this,"percentMale",()=>this.percentOf(1));d(this,"ratio",()=>this.data.split(":").map(t=>parseInt(t)));d(this,"percentOf",t=>{if(this.isGenderless())return 0;const s=this.ratio();return fe(100*s[t]/(s[0]+s[1]))})}}const fe=i=>i<50?Math.ceil(i):Math.floor(i),f=class f extends c{portrait({shiny:e=!1}={}){return e&&this.data.values.shinyPortrait!==void 0?{value:this.data.values.shinyPortrait,hueRotate:0}:e&&this.data.values.shinyPortrait===void 0?{value:this.data.values.normalPortrait,hueRotate:this.customization.shinyHue}:{value:this.data.values.normalPortrait,hueRotate:0}}sprite({shiny:e=!1}={}){return e&&this.data.values.shinySprite!==void 0?{value:this.data.values.shinySprite,hueRotate:0,portraitFallback:!1}:this.data.values.normalSprite!==void 0?{value:this.data.values.normalSprite,hueRotate:e?this.customization.shinyHue:0,portraitFallback:!1}:e&&this.data.values.shinyPortrait!==void 0?{value:this.data.values.shinyPortrait,hueRotate:0,portraitFallback:!0}:{value:this.data.values.normalPortrait,hueRotate:e?this.customization.shinyHue:0,portraitFallback:!0}}hasAnyMedia(){return Object.values(this.data.values).some(e=>e!=null)}get customization(){return this.data.customization??{shinyHue:0}}static forEachType(e){return new f({values:f.types.reduce((t,s)=>({...t,[s]:e(s)}),{})})}};d(f,"types",["normalPortrait","normalSprite","shinyPortrait","shinySprite"]),d(f,"attributionTypes",[{name:"Human Drawn",value:"human"},{name:"AI Generated",value:"ai"},{name:"Other",value:"other"}]);let v=f;class ge extends c{}class _e extends c{constructor(){super(...arguments);d(this,"toString",()=>this.data<=.125?"⅛":this.data<=.25?"¼":this.data<=.5?"½":Math.round(this.data).toString())}}class A extends c{get id(){return new h(this.data.id)}get name(){return this.data.name}get type(){return new X(this.data.type)}get gender(){return new pe(this.data.gender)}get sr(){return new _e(this.data.sr)}get eggGroups(){return new ee(this.data.eggGroups)}get hitDice(){return new D(this.data.hitDice)}get speed(){return new M(this.data.speed)}get senses(){return new R(this.data.senses)}get attributes(){return new Z(this.data.attributes)}get skills(){return new C(this.data.skills)}get media(){return new v(this.data.media)}get moves(){return new ge(this.data.moves)}get abilities(){return new P(this.data.abilities)}numberAsString(){return`#${this.data.number.toString().padStart(4,"0")}`}static fromJson(e){return new A({id:h.fromSpeciesName(e.id).data,name:e.name,number:e.number,type:e.type,size:e.size,sr:e.sr,minLevel:e.minLevel,eggGroups:e.eggGroup,gender:e.gender,description:e.description,ac:e.ac,hp:e.hp,hitDice:e.hitDice,speed:E.fromList(M,e.speed).data,senses:E.fromList(R,e.senses).data,attributes:e.attributes,skills:C.fromList(e.skills).data,saves:e.savingThrows,abilities:P.fromList(e.abilities).data,moves:e.moves,media:{values:{normalPortrait:{name:e.media.main,href:e.media.main},normalSprite:e.media.sprite?{name:e.media.sprite,href:e.media.sprite}:void 0,shinyPortrait:e.media.mainShiny?{name:e.media.mainShiny,href:e.media.mainShiny}:void 0,shinySprite:e.media.spriteShiny?{name:e.media.spriteShiny,href:e.media.spriteShiny}:void 0},customization:{shinyHue:0},attribution:e.media.attribution?{href:e.media.attribution,portrait:{type:"other",name:"",href:""},sprite:{type:"other",name:"",href:""}}:void 0}})}}class ye{constructor(e,t){d(this,"info",async(e,t)=>{try{if(t.media!=null){const s=await this.provider.updateMedia(e.data.writeKey,t.media);v.types.forEach(a=>{var r,n;((r=t.media.data.values[a])==null?void 0:r.type)==="remove"?e.data.species.media.values[a]=void 0:((n=t.media.data.values[a])==null?void 0:n.type)==="new"&&(e.data.species.media.values[a]=s.data.values[a])})}await this.provider.update(e),this.fakemonStore.update(s=>({...s,[e.data.readKey]:{value:e,update:this}}))}catch(s){throw de.show(s.message),s}});this.provider=e,this.fakemonStore=t}}class be{constructor(e){d(this,"upload",async(e,t)=>{const s=await fetch(e,{method:"PUT",body:t,headers:{"Content-Type":t.type,"Content-Length":t.size.toString()}});if(!s.ok)throw console.error(await s.text()),new we("Could not upload file.")});this.baseUrl=e}getAssetUrl(e){return`${this.baseUrl}/${e}`}}class we extends Error{constructor(e,t){super(e+(t!=null&&t.code?` Code: ${t.code}`:"")),this.diagnostics=t}}const Se=new be(le);class _ extends Error{constructor(e){super(e)}}class xe extends _{constructor(){super("You do not have permission to edit this pokemon.")}}class T extends c{get species(){return new A(this.data.species)}}d(T,"alphabetical",(e,t)=>e.data.species.name.localeCompare(t.data.species.name));const te="fakemon::",F=i=>`${te}${i}`;function I(i){const e=F(i),t=localStorage.getItem(e);if(t!=null)try{return{...JSON.parse(t),readKey:i}}catch(s){console.warn(s);return}}function Ee(i){const e=I(i.readKey),t=F(i.readKey);localStorage.setItem(t,JSON.stringify({id:i.id??(e==null?void 0:e.id),writeKey:i.writeKey??(e==null?void 0:e.writeKey)}))}function Ce(){const i=[];for(let e=0;e<localStorage.length;++e){const t=localStorage.key(e);if(!t.startsWith(te))continue;const s=I(t.split("::")[1]);s!=null&&i.push(s)}return i}function Pe(i){const e=F(i);localStorage.removeItem(e)}const m={get:I,add:Ee,list:Ce,remove:Pe};class Ke{constructor(e,t){d(this,"handleNewMedia",async(e,t)=>{var r;const{data:s,error:a}=await this.supabase.functions.invoke("user-assets",{method:"POST",body:{type:"fakemon-media",params:{key:e,...(r=v.forEachType(n=>{var o;return((o=t.data.values[n])==null?void 0:o.type)==="new"?{mimetype:t.data.values[n].value.type,sizeInBytes:t.data.values[n].value.size}:void 0}))==null?void 0:r.data.values}}});if(a)throw new _("Could not upload file(s) for fakemon.");return await Promise.all(v.types.map(n=>{var o;return s.values[n]!=null&&((o=t.data.values[n])==null?void 0:o.type)==="new"?this.userAssets.upload(s.values[n].uploadUrl,t.data.values[n].value):void 0}).filter(n=>n!=null)),v.forEachType(n=>{var o;return s.values[n]!=null&&((o=t.data.values[n])==null?void 0:o.type)==="new"?this.getUserAssetResource(s.values[n].filename):void 0})});d(this,"handleRemovedMedia",async(e,t)=>{const{error:s}=await this.supabase.functions.invoke("user-assets",{method:"DELETE",body:{type:"fakemon-media",params:{key:e,...v.forEachType(a=>{var r;return((r=t.data.values[a])==null?void 0:r.type)==="remove"}).data.values}}});if(s)throw new _("Could not remove file(s) for fakemon.")});d(this,"getUserAssetResource",e=>({name:e,href:this.userAssets.getAssetUrl(e)}));this.supabase=e,this.userAssets=t}async getAllKnown(){return Promise.all(m.list().map(e=>this.getByReadKey(e.readKey))).then(e=>e.filter(t=>t!=null))}async getByReadKey(e){return this.supabase.rpc("get_fakemon",{_read_key:e}).maybeSingle().then(({data:t,error:s})=>{if(this.validateError("Could not get fakemon.",s),!t)return;const a=Te(t,this.getUserAssetResource),r=m.get(e);return a.data.writeKey=r==null?void 0:r.writeKey,m.add(a.data),a})}async add(e){const{data:t,error:s}=await this.supabase.rpc("new_fakemon",this.toQuery(e)).single();this.validateError("Could not add fakemon.",s);const a={id:t.ret_id,readKey:t.ret_read_key,writeKey:t.ret_write_key};return m.add(a),new T({species:{...e,id:h.fromFakemonReadKey(a.readKey).data},...a})}async update(e){const t=e.data.writeKey;if(t==null)throw new xe;const{data:s,error:a}=await this.supabase.rpc("update_fakemon",{_write_key:t,...this.toQuery(e.data.species)}).single();return this.validateError("Could not edit fakemon.",a),s>0}async updateMedia(e,t){const[s]=await Promise.all([this.handleNewMedia(e,t),this.handleRemovedMedia(e,t)]);return s}async verifyWriteKey(e,t){const{data:s,error:a}=await this.supabase.rpc("verify_fakemon_write_key",{_id:e.data.id,_write_key:t}).single();if(a)throw new _("Could not verify fakemon.");return s>0&&m.add({id:e.data.id,readKey:e.data.readKey,writeKey:t}),s>0}validateError(e,t){if(t)throw console.error(t),new _(e)}toQuery(e){var t,s,a,r,n,o,l,u,N,B,j,U,G;return{_species_name:e.name,_type:e.type,_size:e.size,_sr:e.sr,_min_level:e.minLevel,_egg_groups:e.eggGroups,_gender:e.gender,_description:e.description,_ac:e.ac,_hp:e.hp,_hit_dice:e.hitDice,_speed_walking:e.speed.walking??0,_speed_climbing:e.speed.climbing??0,_speed_swimming:e.speed.swimming??0,_speed_flying:e.speed.flying??0,_speed_hover:e.speed.hover??0,_speed_burrowing:e.speed.burrowing??0,_sense_darkvision:e.senses.darkvision??0,_sense_blindsight:e.senses.blindsight??0,_sense_tremorsense:e.senses.tremorsense??0,_sense_truesight:e.senses.truesight??0,_strength:e.attributes.str,_dexterity:e.attributes.dex,_constitution:e.attributes.con,_intelligence:e.attributes.int,_wisdom:e.attributes.wis,_charisma:e.attributes.cha,_prof_athletics:e.skills.athletics>0,_prof_acrobatics:e.skills.acrobatics>0,_prof_sleight_of_hand:e.skills["sleight of hand"]>0,_prof_stealth:e.skills.stealth>0,_prof_arcana:e.skills.arcana>0,_prof_history:e.skills.history>0,_prof_investigation:e.skills.investigation>0,_prof_nature:e.skills.nature>0,_prof_religion:e.skills["religion fakemon"]>0,_prof_animal_handling:e.skills["animal handling"]>0,_prof_insight:e.skills.insight>0,_prof_medicine:e.skills.medicine>0,_prof_perception:e.skills.perception>0,_prof_survival:e.skills.survival>0,_prof_deception:e.skills.deception>0,_prof_intimidation:e.skills.intimidation>0,_prof_performance:e.skills.performance>0,_prof_persuasion:e.skills.persuasion>0,_save_str:e.saves.includes("str"),_save_dex:e.saves.includes("dex"),_save_con:e.saves.includes("con"),_save_int:e.saves.includes("int"),_save_wis:e.saves.includes("wis"),_save_cha:e.saves.includes("cha"),_abilities:e.abilities.normal,_hidden_abilities:e.abilities.hidden,_moves_start:e.moves.start,_moves_level2:e.moves.level2,_moves_level6:e.moves.level6,_moves_level10:e.moves.level10,_moves_level14:e.moves.level14,_moves_level18:e.moves.level18,_moves_egg:e.moves.egg,_moves_tm:e.moves.tm,_art_attribution_type:((s=(t=e.media.attribution)==null?void 0:t.portrait)==null?void 0:s.type)??null,_art_attribution_name:((r=(a=e.media.attribution)==null?void 0:a.portrait)==null?void 0:r.name)??null,_art_attribution_href:((o=(n=e.media.attribution)==null?void 0:n.portrait)==null?void 0:o.href)??null,_sprite_attribution_type:((u=(l=e.media.attribution)==null?void 0:l.sprite)==null?void 0:u.type)??null,_sprite_attribution_name:((B=(N=e.media.attribution)==null?void 0:N.sprite)==null?void 0:B.name)??null,_sprite_attribution_href:((U=(j=e.media.attribution)==null?void 0:j.sprite)==null?void 0:U.href)??null,_shiny_hue_rotation:((G=e.media.customization)==null?void 0:G.shinyHue)??0,_notes:e.notes??""}}}const Ae=i=>Object.entries(i).filter(([,e])=>e).map(([e])=>e);function Te(i,e){return new T({id:i.id,readKey:i.read_key,writeKey:i.write_key,species:{id:h.fromFakemonReadKey(i.read_key).data,name:i.species_name,type:i.type.filter(X.isPokeType),number:0,size:me(i.size)?i.size:"small",sr:parseFloat(i.sr),minLevel:i.min_level,eggGroups:i.egg_groups,gender:i.gender,description:i.description,ac:i.ac,hp:i.hp,hitDice:D.isHitDice(i.hit_dice)?i.hit_dice:"d6",speed:{walking:i.speed_walking,swimming:i.speed_swimming,climbing:i.speed_climbing,flying:i.speed_flying,hover:i.speed_hover,burrowing:i.speed_burrowing},senses:{darkvision:i.sense_darkvision,blindsight:i.sense_blindsight,tremorsense:i.sense_tremorsense,truesight:i.sense_truesight},attributes:{str:i.strength,dex:i.dexterity,con:i.constitution,int:i.intelligence,wis:i.wisdom,cha:i.charisma},skills:{athletics:i.prof_athletics?1:0,acrobatics:i.prof_acrobatics?1:0,"sleight of hand":i.prof_sleight_of_hand?1:0,stealth:i.prof_stealth?1:0,arcana:i.prof_arcana?1:0,history:i.prof_history?1:0,investigation:i.prof_investigation?1:0,nature:i.prof_nature?1:0,religion:i.prof_religion?1:0,"animal handling":i.prof_animal_handling?1:0,insight:i.prof_insight?1:0,medicine:i.prof_medicine?1:0,perception:i.prof_perception?1:0,survival:i.prof_survival?1:0,deception:i.prof_deception?1:0,intimidation:i.prof_intimidation?1:0,performance:i.prof_performance?1:0,persuasion:i.prof_persuasion?1:0},saves:Ae({str:i.save_str,dex:i.save_dex,con:i.save_con,int:i.save_int,wis:i.save_wis,cha:i.save_cha}),abilities:{normal:i.abilities,hidden:i.hidden_abilities},moves:{start:i.moves_start,level2:i.moves_level2,level6:i.moves_level6,level10:i.moves_level10,level14:i.moves_level14,level18:i.moves_level18,egg:i.moves_egg,tm:i.moves_tm},media:{values:{normalPortrait:i.normal_portrait_filename?e(i.normal_portrait_filename):void 0,normalSprite:i.normal_sprite_filename?e(i.normal_sprite_filename):void 0,shinyPortrait:i.shiny_portrait_filename?e(i.shiny_portrait_filename):void 0,shinySprite:i.shiny_sprite_filename?e(i.shiny_sprite_filename):void 0},customization:{shinyHue:i.shiny_hue_rotation},attribution:{portrait:{type:i.art_attribution_type??"",name:i.art_attribution_name??"",href:i.art_attribution_href??""},sprite:{type:i.sprite_attribution_type??"",name:i.sprite_attribution_name??"",href:i.sprite_attribution_href??""}}},notes:i.notes??""}})}const S=new Ke(Y,Se);function K(i,e){return{value:i,update:i.data.writeKey!=null?new ye(S,e):void 0}}function J(i,e){return{subscribe:t=>e.subscribe(s=>{t(s[i.value.data.readKey]??i)}),verifyAccess:async t=>{const s=await S.verifyWriteKey(i.value,t);return s&&e.update(a=>({...a,[i.value.data.readKey]:K(i.value.copy({writeKey:t}),e)})),s},remove:async()=>{e.update(t=>{const{[i.value.data.readKey]:s,...a}=t;return a}),m.remove(i.value.data.readKey)}}}function Le(i,e){let t=!1;return{subscribe:s=>e.subscribe(a=>{s(Object.values(a).map(r=>r.value).sort(T.alphabetical)),t||(t=!0,e.update(r=>i.reduce((n,o)=>({...n,[o.data.readKey]:K(o,e)}),r)))})}}function $e(){const i=b({}),e={};let t;return{get:async s=>(e[s]==null&&(e[s]=S.getByReadKey(s).then(a=>{if(a==null)return;const r=K(a,i);return i.update(n=>({...n,[a.data.readKey]:r})),J(r,i)})),e[s]),new:async s=>S.add(s).then(a=>{const r=K(a,i),n=J(r,i);return e[a.data.readKey]=Promise.resolve(n),i.update(o=>({...o,[a.data.readKey]:r})),a}),all:async()=>(t==null&&(t=S.getAllKnown().then(s=>Le(s,i))),t),getWriteKey:s=>m.get(s).writeKey,reset:async()=>{i.set({})}}}const W=$e();function z(i,e){let t;return V(i,(s,a)=>{t!=null?s(t):e(r=>{t=r,s(r)},r=>{a(n=>{const o=r(n);return t=o,o})})})}const L=z(void 0,i=>{typeof window<"u"&&fetch(`${k}/pokemon/v2.json`).then(e=>e.json()).then(e=>e.items.map(t=>A.fromJson(t))).then(e=>i(e))});function Me(){return{get:async i=>{if(i.isFakemon()){const e=await W.get(i.toFakemonReadKey());return e==null?void 0:w(e,t=>({value:t.value.species}))}else return w(L,e=>{const t=e==null?void 0:e.find(s=>s.id.data===i.data);if(t!=null)return{value:t}})},canonList:()=>L,completeList:async()=>{const i=await W.all();return w([L,i],([e,t])=>e==null?void 0:e.concat(t.map(s=>s.species)))}}}const gt=Me(),Re={fromType(i){switch(i.type){case"level":return new ie(i.value);case"item":return new ke(i.value);case"loyalty":return new De(i.value);case"move":return new Fe(i.value);case"move-type":return new Ie(i.value);case"gender":return new se(i.value);case"time":return new ze(i.value);case"special":return new q(i.value);default:return new q("")}}},_t=["day","night","morning","afternoon"];class ie{constructor(e){this.targetLevel=e}meetsCondition(e){return e.level.data>=this.targetLevel}toString(){return`at level ${this.targetLevel} or above`}}class ke{constructor(e){this.itemName=e}meetsCondition(){return!0}toString(){return`using a ${this.itemName}`}}class De{constructor(e){this.targetLevel=e}meetsCondition(e){return e.bond.level>=this.targetLevel}toString(){return`with a bond of +${this.targetLevel} or higher`}}class Fe{constructor(e){this.requiredMove=e}meetsCondition(e){return e.moves.some(t=>t.moveId===this.requiredMove)}toString(){return`while knowing {{move::${this.requiredMove}}}`}}class Ie{constructor(e){this.requiredType=e}meetsCondition(){return!0}toString(){return`while knowing a ${this.requiredType}-type move`}}class se{constructor(e){this.gender=e}meetsCondition(e){return e.gender===this.gender}toString(){return`A ${this.gender}`}}class ze{constructor(e){this.time=e}meetsCondition(){return!0}toString(){return`during the ${this.time}`}}class q{constructor(e){this.condition=e}meetsCondition(){return!0}toString(){return this.condition}}const Oe={fromType(i){switch(i.type){case"asi":return new Ne(i.value);case"special":return new Q(i.value);default:return new Q("")}}};class Ne{constructor(e){this.amount=e}toString(){return`its health increases by double its level, and it gains ${this.amount} points to add to its ability scores`}}class Q{constructor(e){this.effect=e}toString(){return this.effect}}let Be=0;function yt(){return`TMP.${++Be}`}class x extends c{get id(){return this.data.id}get from(){return new h(this.data.from)}get to(){return new h(this.data.to)}get conditions(){return this.data.conditions.map(e=>Re.fromType(e))}get benefits(){return this.data.effects.map(e=>Oe.fromType(e))}isSame(e){return this.data.from===e.data.from&&this.data.to===e.data.to}isDraft(){return this.data.id.startsWith("TMP.")}hasCondition(e){return this.data.conditions.some(t=>t.type===e.type&&t.value===e.value)}toString(){const e=this.conditions,t=this.benefits,s=e.find(n=>n instanceof se),a=e.find(n=>n instanceof ie),r=e.filter(n=>n!==s&&n!==a);return`${s?s.toString()+" ":""}{{pokemon:${this.data.from}}} can evolve into {{pokemon::${this.data.to}}} ${a?a.toString():""}${r.length>0&&a?" ":""}${r.map(n=>n.toString()).join(", ")}. When it evolves, ${t.map(n=>n.toString()).join(", ")}.`}static fromJson(e){return new x(e)}}class O{constructor(e){d(this,"evolutions",[]);d(this,"nodes");this.nodes=new Map,this.addAll(e)}hasEvolutionTree(e){return this.maxStage(e)>1}evolvesFrom(e){return this.evolutions.filter(t=>t.to.data===e.data)}evolvesTo(e){return this.evolutions.filter(t=>t.from.data===e.data)}allEvolutions(e){return this.evolvesFrom(e).concat(this.evolvesTo(e))}hasCondition(e,t){return this.evolvesTo(e).some(s=>s.hasCondition(t))}currentStage(e){const t=this.nodes.get(e.data);let s=0;if(t!=null){const a={};if(this.dfs(t,"from",(r,n)=>{s=Math.max(s,n)},a),a.cycle)return 0}return s+1}maxStage(e){const t=this.currentStage(e),s=this.nodes.get(e.data);let a=0;if(s!=null){const r={};if(this.dfs(s,"to",(n,o)=>{a=Math.max(a,o)},r),r.cycle)return 1/0}return t+a}addAll(e){const t=e.filter(a=>!this.evolutions.find(r=>r.isSame(a)));this.evolutions.push(...t);const s=this.nodes;for(const a of t){s.has(a.data.from)||s.set(a.data.from,{id:a.from,edges:{from:[],to:[]}}),s.has(a.data.to)||s.set(a.data.to,{id:a.to,edges:{from:[],to:[]}});const r=s.get(a.data.from),n=s.get(a.data.to);r.edges.to.push(n),n.edges.from.push(r)}}update(e){const t=this.evolutions.findIndex(s=>s.id===e.id);t>=0&&this.evolutions.splice(t,1).forEach(a=>this.removeNode(a)),this.remove(e),this.addAll([e])}remove(e){const t=this.evolutions.findIndex(s=>s.isSame(e));t<0||(this.evolutions.splice(t,1),this.removeNode(e))}clone(){return new O(this.evolutions.map(e=>e.copy()))}removeNode(e){const t=this.nodes.get(e.data.from),s=this.nodes.get(e.data.to);t&&(t.edges.to=t.edges.to.filter(a=>a.id.data!==e.data.to)),s&&(s.edges.from=s.edges.from.filter(a=>a.id.data!==e.data.from))}dfs(e,t,s,a,r=0,n=[]){if(n.includes(e)){a.cycle=!0;return}s(e,r);const o=[...n,e];for(const l of e.edges[t])this.dfs(l,t,s,a,r+1,o)}}class y extends Error{constructor(e,t){super(`${e}${t!=null?` (${t.from} to ${t.to})`:""}`)}}class je extends y{constructor(e){super("Evolution already exists",e)}}class Ue{constructor(e){this.supabase=e}async get(e,t=[]){if(!e.isFakemon())return[];if(t.includes(e.data))return[];const{data:s,error:a}=await this.supabase.rpc("get_fakemon_evolutions",{_fakemon_id:e.data}).select();this.validateError("Could not get evolutions.",a),t.push(e.data);const r=new Map;for(const n of s){const o=Ge(n);r.set(o.id,o),await Promise.all([this.get(o.from,t),this.get(o.to,t)]).then(l=>{l.flat().forEach(u=>{r.set(u.id,u)})})}return Array.from(r.values())}async add(e,t){const{data:s,error:a}=await this.supabase.rpc("add_fakemon_evolution",this.toQuery(e,t)).single();if(this.validateError("Could not add evolution",a,e),s==null)throw new y("Could not add evolution",e);return new x({...e,id:s.toString()})}async update(e,t,s){const{data:a,error:r}=await this.supabase.rpc("update_fakemon_evolution",{_id:e.data.id,_original_from_write_key:s.from??null,_original_to_write_key:s.to??null,...this.toQuery(e.data,t)}).single();if(this.validateError("Could not update evolution.",r,e.data),a<1)throw new y("Could not update evolution.",e.data);return e}async remove(e,t){const{data:s,error:a}=await this.supabase.rpc("remove_fakemon_evolution",{_id:e,_original_from_write_key:t.from??null,_original_to_write_key:t.to??null}).single();if(this.validateError("Could not remove evolution.",a),s<1)throw new y("Could not remove evolution.")}toQuery(e,t){return{_from_id:e.from,_from_write_key:t.from??null,_to_id:e.to,_to_write_key:t.to??null,_conditions:JSON.stringify(e.conditions),_effects:JSON.stringify(e.effects)}}validateError(e,t,s){if(t)throw console.error(t),t.code===ue.UniqueViolation?new je(s):new y(e,s)}}function Ge(i){return new x({id:i.id.toString(),from:i.from_id,to:i.to_id,conditions:JSON.parse(i.conditions),effects:JSON.parse(i.effects)})}const g=new Ue(Y),ae=z(void 0,i=>{typeof window<"u"&&fetch(`${k}/evolutions/v1.json`).then(e=>e.json()).then(e=>e.items.map(t=>x.fromJson(t))).then(e=>i(new O(e)))}),$=z(void 0,i=>{let e;e=ae.subscribe(t=>{t!=null&&(i(t.clone()),e==null||e())})});function He(){const i=new Map,e=b(!1),t=r=>(i.has(r.data)||i.set(r.data,b(!r.isFakemon())),i.get(r.data)),s=r=>{var n;i.has(r.data)?(n=i.get(r.data))==null||n.set(!0):i.set(r.data,b(!0))},a=r=>{var n,o;(n=i.get(r.from.data))==null||n.set(!1),(o=i.get(r.to.data))==null||o.set(!1)};return{get:r=>{const n=t(r);return w([$,n],([o,l])=>{if(o!=null){if(!l){g.get(r).then(u=>{o.addAll(u),n.set(!0)});return}return o}})},all:()=>w([$,e],([r,n])=>{if(r!=null){if(!n){Promise.all(m.list().map(o=>{const l=h.fromFakemonReadKey(o.readKey);return g.get(l).then(u=>{r.addAll(u),s(l)})})).then(()=>{e.set(!0)});return}return r}}),update:async r=>{const n=ce($);if(n==null)throw new Error("Theoretically unreachable");const o=[];await Promise.all(r.map(async l=>{if(l.type==="upsert"&&l.evolution.isDraft()){const u=await g.add(l.evolution.data,l.writeKeys);n.addAll([u]),o.push(u)}else if(l.type==="upsert"){const u=await g.update(l.evolution,l.writeKeys,l.originalKeys);n.update(u),o.push(u)}else l.type==="remove"&&(await g.remove(l.evolution.id,l.writeKeys),n.remove(l.evolution))})),o.forEach(l=>a(l))},canonList:()=>ae}}const bt=He(),re="canCreateCustomPokemonBannerVisibility",Je=localStorage.getItem(re)==="true",We=b(Je);We.subscribe(i=>localStorage.setItem(re,i.toString()));export{P as A,We as C,ee as E,T as F,pe as G,D as H,A as P,gt as S,_t as T,h as a,bt as b,ft as c,Z as d,M as e,R as f,C as g,W as h,v as i,_e as j,x as k,he as l,me as m,yt as t,Se as u};
